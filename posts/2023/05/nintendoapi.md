---
title: ぶっちゃけOAuthはどこまでデータ抜けるんですか
publish_date: 2023-05-24
description: Salmonia3+の権限の強さとか、セキュリティとかについて語ります
---

## 任天堂、サードパーティアプリを認識していた

> [ご注意]『スプラトゥーン3』などのネットワークサービスにおいて正規アプリになりすまし、当社サーバーに不正にアクセスするスマホアプリの存在を確認しております。このようなアプリの利用はセキュリティや個人情報が脅かされたり、思わぬ被害を受けたりする可能性が考えられます。ご注意ください。

という[注意喚起](https://twitter.com/nintendo_cs/status/1661198043461603328)が任天堂からされていました。

さて、これについてわたし自身がどう思っているかということなのですが「全くもってその通りである」という一言に付きます。「もっといいアプリをつくれ」とか「APIを公開しろ」とかは全く思っていません。そりゃ、APIがあれば嬉しいですけれど......

では何故そう思うのか、ぶっちゃけSalmonia3+はどこまで個人のデータが抜けて、セキュリティはどうなっているのかについて解説します。

## Salmonia3+の権限

以下の文章は長いので、先に結論を書いておきます。

- パスワードとIDを知ることはできない
- トークンには権限があり、できることは限られている
- トークンは厳重に保護されている
- とはいえ、非公式アプリを安易に使うべきではない

### パスワードとID

さて、Salmonia3+ではログイン時にパスワードとIDを入力してニンテンドースイッチオンラインのアカウントに連携する必要があります。

「これ、入力しちゃって大丈夫なの？」と思った方も多いと思いますし、極めて自然なことだと思います。

これに対する回答は「あのログインページは任天堂公式のものであるため安全である」ということです。アプリ側からは入力されたパスワードはもちろん、IDすらも知ることができません。

ただ一つ注意点があり、悪意のある開発者が偽のアプリを作って公式のログインページにそっくりなものをつくったとすれば、そこに入力したパスワードとIDは筒抜けになってしまうということです。

> これが非公式アプリを使うことに対して最も注意しなければいけない点といえます

スマートフォンのアプリ内ブラウザからはそういう点をしっかりとチェックすることができないので、信頼できないアプリは安易に使うべきではありません。

### トークン

ではアプリはどうやってパスワードとIDがわからないのにイカリング3からデータを取得しているのでしょうか？

これは、パスワードとIDに代わるトークンというものを利用して「アクセスしている人が本人である」ということをチェックできるからです。トークンは使いまわしで有効期限があるため、簡単に変えることができないパスワードやIDに比べて安全というわけですね。

トークン自体はIDとパスワードの代わりのようなものなので、当然外部に洩れてしまうと不正にアカウントにアクセスできてしまいます。しかしながら、トークンには「権限」というものがあります。

これがどういうことかというと、例えばIDとパスワードがあれば「クレジットカード情報やID、氏名、住所などのアカウントのすべてのデータにアクセスできる」とすれば「データ取得の権限しかない」トークンを発行すれば、そのトークンが洩れたとしてもそれらの秘匿にすべき個人情報にはアクセスできないということです。

じゃあ気になるのはSalmonia3+で使われているトークンにはどんな権限が設定されているか、ということですよね。

#### トークンの権限

Salmonia3+が利用しているトークンがもっている権限は以下の五つです。

- openid
- user
- user.birthday
- user.mii
- user.screenName

この権限は公式のニンテンドースイッチオンラインのアプリと全く同じであり、それ以上の権限は持ちません。本当かどうか気になる人は[ソースコード](https://github.com/tkgstrator/SplatNet3/blob/master/Sources/SplatNet3/Extensions/URL.swift)を読むか、Fiddlerなどを通してパケットキャプチャしていただければわかります。

で、上の権限を見ても「実際、何が見れるんですか？」ということになりますね。

| 権限            | 内容           | 
| :-------------: | :------------: | 
| openid          | 必須           | 
| user            | 性別・国・言語 | 
| user.birthday   | 生年月日       | 
| user.mii        | 不明           | 
| user.screenName | アカウント名   | 

で、見れるのは大雑把に表のような感じです。生年月日が必要になっているのはある年齢以下ではイカリングが利用できないためで、その判定に使われています。

> とはいえSalmonia3+では年齢確認をパスしているので実際には必要ないのですが......

なので、Salmonia3+の開発者がこっそりユーザーのトークンを盗んだとしてもわかるのは性別と生年月日だけで、氏名すらわかりません。当然ですが、クレジットカードの情報もわかりません。

### セキュリティ

万が一洩れても大丈夫とはいえ、トークンは外部に洩れるべきではありません。

ではそのトークンはアプリ内のどこに保存されているのかということになります。

名前は伏せますが、とあるアプリでは全く暗号化されずにファイルとしてトークン情報が保存されていたことがありました。iOSのセキュリティは基本的には堅いので大丈夫だとは思いますが、これは結構危ないです。

Salmonia3+では個人情報を含むデータは全て[Keychain](https://developer.apple.com/documentation/security/keychain_services)と呼ばれるセキュアな領域に保存しています。Apple謹製のセキュリティガチガチな仕組みなので、一般の方は十分に安心して良いセキュリティレベルだと思います。

## ログ送信について

Salmonia3+ではログ送信を行うことで、開発者がバグの原因を突き止めやすくなるシステムを採用しています。

で、このログ送信時には全ての認証情報は削除された上で送信されています。ただし、ログには以下の情報が含まれています。

- iOSのバージョン
- アプリのバージョン
- デバイスのUUID
  - ランダムな値です
- フレンドコード
  - 送られてはきていますが、使っていないので秘匿にしても良いかなとは思います
- nsaid
  - Nintendo Switch Account Idの略です
  - イカリング2などから誰でも他人のこの値を確認できるので秘匿にしていません
- npln_user_id
  - スプラトゥーン3用の専用IDです
  - オンラインでマッチングした相手のIDは誰でも調べることができます
  - よって、秘匿していません

というわけで、既に利用されている方は基本的にはSalmonia3+は安心して使っていただいて大丈夫です。
